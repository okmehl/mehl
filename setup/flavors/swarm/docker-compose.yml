{% set env='mehl.env' %}
# This file is auto-generated by the Mehl configuration wizard.
# Please read the documentation before attempting any change.
#
# Generated for Docker Swarm
#
version: '3.6'

services:

# External dependencies
  redis:
    image: redis:alpine
    networks:
      - net
    volumes:
      - "{{ root }}/redis:/data"

  memcached:
    image: memcached:alpine
    networks:
      - net

  db:
    image: mariadb
    networks:
      - net
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    volumes:
      - "{{ root }}/mysql:/var/lib/mysql"
    deploy:
      replicas: 1
    environment:
      - MYSQL_ROOT_PASSWORD={{ secret(16) }}
      - MYSQL_PASSWORD={{ db_pw }}
      - MYSQL_DATABASE=mehl
      - MYSQL_USER=mehl
      - MYSQL_INITDB_SKIP_TZINFO=1

# Core services
  front:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}nginx:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
      - {{ traefik_network }}
    logging:
      driver: {{ log_driver or 'json-file' }}
    volumes:
      - "{{ root }}/certs:/certs"
    ports:
      - target: 25
        published: 25
        protocol: tcp
        mode: host
      - target: 465
        published: 465
        protocol: tcp
        mode: host
      - target: 587
        published: 587
        protocol: tcp
        mode: host
      - target: 110
        published: 110
        protocol: tcp
        mode: host
      - target: 995
        published: 995
        protocol: tcp
        mode: host
      - target: 143
        published: 143
        protocol: tcp
        mode: host
      - target: 993
        published: 993
        protocol: tcp
        mode: host
    deploy:
      endpoint_mode: dnsrr
      replicas: 1
      resources:
        limits:
          cpus: '1.00'
          memory: 256M
      labels:
        - traefik.enable=true
        - traefik.docker.network={{ traefik_network }}
        - traefik.http.services.mehl_front.loadbalancer.server.port=80
        - traefik.http.routers.mehl_front.entryPoints={{ traefik_entrypoint }}
        - traefik.http.routers.mehl_front.service=mehl_front
        - traefik.http.routers.mehl_front.rule=Host(`{{ traefik_hostname }}`)
        - traefik.http.routers.mehl_front.middlewares={{ traefik_middlewares }}
        - traefik.http.routers.mehl_front.tls=true
        - traefik.http.routers.mehl_front.tls.certresolver={{ traefik_ssl_resolver }}

  admin:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}admin:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/data:/data"
      - "{{ root }}/dkim:/dkim"
    deploy:
      replicas: 1
      labels:
    healthcheck:
      disable: true

  imap:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}dovecot:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/mail:/mail"
    configs:
      - source: dovecot_config
        target: /etc/dovecot/dovecot.conf
      - source: dovecot_sql_config
        target: /etc/dovecot/dovecot-sql.conf
      - source: dovecot_report_ham_config
        target: /etc/dovecot/report-ham.sieve
      - source: dovecot_report_spam_config
        target: /etc/dovecot/report-spam.sieve
      - source: dovecot_rspamd_pipe_ham_config
        target: /etc/dovecot/rspamd-pipe-ham
      - source: dovecot_rspamd_pipe_spam_config
        target: /etc/dovecot/rspamd-pipe-spam
    deploy:
      replicas: 1

  smtp:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}postfix:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/mailqueue:/queue"
    configs:
      - source: postfix_main_config
        target: /etc/postfix/main.cf
      - source: postfix_master_config
        target: /etc/postfix/master.cf
      - source: postfix_mysql_relay_config
        target: /etc/postfix/mysql_relay_domains.cf
      - source: postfix_mysql_alias_config
        target: /etc/postfix/mysql_virtual_alias_maps.cf
      - source: postfix_mysql_domains_config
        target: /etc/postfix/mysql_virtual_mailbox_domains_maps.cf
      - source: postfix_mysql_mailbox_config
        target: /etc/postfix/mysql_virtual_mailbox_maps.cf
      - source: postfix_outclean_header_config
        target: /etc/postfix/outclean_header_filter.cf
    deploy:
      endpoint_mode: dnsrr
      replicas: 1

  antispam:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}rspamd:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/filter:/var/lib/rspamd"
      - "{{ root }}/dkim:/dkim:ro"
    deploy:
      replicas: 1

  antivirus:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}clamav:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/filter:/data"
    deploy:
      replicas: 1

  {% if fetchmail_enabled %}
  fetchmail:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}fetchmail:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/data:/data"
    deploy:
      replicas: 1
  {% endif %}

  webmail:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}sogo:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    networks:
      - net
    volumes:
      - "{{ root }}/webmail:/data"
    configs:
      - source: sogo_config
        target: /etc/sogo/sogo.conf
    deploy:
      replicas: 1

  certdumper:
    image: ${DOCKER_ORG:-okmehl}/${DOCKER_PREFIX:-}traefik-certdumper:${MEHL_VERSION:-{{ version }}}
    env_file: {{ env }}
    volumes:
      # Folder, which contains the acme.json
      - "{{ traefik_cert_folder }}:/var/lib/acme"
      # Folder, where cert.pem and key.pem will be written
      - "{{ root }}/certs:/output"

configs:
  sogo_config:
    file: "{{ root }}/sogo/sogo.conf"
  dovecot_sql_config:
    file: "{{ root }}/dovecot/dovecot-sql.conf"
  dovecot_config:
    file: "{{ root }}/dovecot/dovecot.conf"
  dovecot_report_ham_config:
    file: "{{ root }}/dovecot/report-ham.sieve"
  dovecot_report_spam_config:
    file: "{{ root }}/dovecot/report-spam.sieve"
  dovecot_rspamd_pipe_ham_config:
    file: "{{ root }}/dovecot/rspamd-pipe-ham"
  dovecot_rspamd_pipe_spam_config:
    file: "{{ root }}/dovecot/rspamd-pipe-spam"
  postfix_main_config:
    file: "{{ root }}/postfix/main.cf"
  postfix_master_config:
    file: "{{ root }}/postfix/master.cf"
  postfix_mysql_relay_config:
    file: "{{ root }}/postfix/mysql_relay_domains.cf"
  postfix_mysql_alias_config:
    file: "{{ root }}/postfix/mysql_virtual_alias_maps.cf"
  postfix_mysql_domains_config:
    file: "{{ root }}/postfix/mysql_virtual_mailbox_domains_maps.cf"
  postfix_mysql_mailbox_config:
    file: "{{ root }}/postfix/mysql_virtual_mailbox_maps.cf"
  postfix_outclean_header_config:
    file: "{{ root }}/postfix/outclean_header_filter.cf"

networks:
  net:
    driver: overlay
  {{ traefik_network }}:
    external: true
